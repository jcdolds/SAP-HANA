
SELECT 	    VBRK.VBELN AS COD_FACTURA,
			VBRK.FKDAT AS FECHA_FACTURA,
			VBRK.VKORG AS COD_ORG_VENTAS,			
			VBRK.VTWEG AS COD_CANAL,
			TVTWT.VTEXT AS NOMBRE_CANAL,
			KNA1.KUNNR AS COD_CLIENTE,
			KNA1.NAME1 AS NOMBRE_CLIENTE,
			KNA1.MCOD3 AS CIUDAD_CLIENTE,
			'' AS PROVINCIA_CLIENTE,
			MARA.SPART AS COD_SECTOR,
			TSPAT.VTEXT AS NOMBRE_SECTOR,
			MARA.MATKL AS COD_GRUPO_MATERIALES,
			T023T.WGBEZ AS GRUPO_MATERIALES,
			MARA.BISMT AS COD_MATERIAL_R3,
			VBRP.MATNR AS COD_MATERIAL_HANA,
			MAKT.MAKTX AS NOMBRE_MATERIAL,
			MARA.LABOR AS COD_MARCA,
			T024X.LBTXT AS MARCA,
			VBPA.KUNNR AS COD_AGENTE,
			VBPA2.KUNNR AS COD_VENDEDOR,
			VBRK.FKART AS TIPO_DOCUMENTO,
			TVFKT.VTEXT AS DESCRIPCION_DOCUMENTO,
			VBRK.ERNAM AS USUARIO,
			VBRP.AUGRU_AUFT AS COD_MOTIVO,
			TVAUT.BEZEI AS MOTIVO_PEDIDO,
			VBRP.VKBUR  AS COD_OFC_VENTA,
			TVKBT.BEZEI AS NOM_OFICINA_VENTA,
			VBRP.VGBEL AS COD_ENTREGA,
			VBRP.VRKME AS UNIDAD_VENTA,
			
			
SUM(CASE
    		WHEN VBRK.FKART = 'ZDV1' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZKR1' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZDP1' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZNC1' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZNR1' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZAS1' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZAS2' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZB01' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZB03' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'ZDT1' THEN (VBRP.FKIMG * -1)
    		WHEN VBRK.FKART = 'S1' THEN (VBRP.FKIMG * -1)
    		ELSE VBRP.FKIMG END) AS CANTIDAD,
			
SUM(CASE
    		WHEN VBRK.FKART = 'ZDV1' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZKR1' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZDP1' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZNC1' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZNR1' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZAS1' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZAS2' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZB01' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZB03' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'ZDT1' THEN (VBRP.WAVWR * -1)
    		WHEN VBRK.FKART = 'S1' THEN (VBRP.WAVWR * -1)
    		ELSE VBRP.WAVWR END) AS COSTO_INTERNO,

SUM(CASE
    		WHEN VBRK.FKART = 'ZDV1' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZKR1' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZDP1' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZNC1' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZNR1' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZAS1' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZAS2' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZB01' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZB03' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'ZDT1' THEN (VBRP.KZWI1 * -1)
    		WHEN VBRK.FKART = 'S1' THEN (VBRP.KZWI1 * -1)
    		ELSE VBRP.KZWI1 END) AS VALOR_ANTES_DESCUENTO,
    		
    		
						
						
    		( SELECT SUM(PRCD_ELEMENTS.KWERT)
    		 FROM SAPABAP1.PRCD_ELEMENTS 
             WHERE PRCD_ELEMENTS.KNUMV = VBRK.KNUMV
             AND PRCD_ELEMENTS.KPOSN = VBRP.POSNR
  			 AND PRCD_ELEMENTS.KSCHL IN ('ZPRC', 'ZK01', 'ZKE1', 'ZKE2' ,'ZK02', 'ZK03','R100', 'ZKEM')
  							   ) AS DESCUENTO,
  							   
  			
   
			
    		SUM(CASE
    		WHEN VBRK.FKART = 'ZDV1' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZKR1' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZDP1' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZNC1' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZNR1' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZAS1' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZAS2' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZB01' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZB03' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'ZDT1' THEN (VBRP.NETWR * -1)
    		WHEN VBRK.FKART = 'S1' THEN (VBRP.NETWR * -1)
    		ELSE VBRP.NETWR END) AS VALOR_ANTES_IVA,
    		
    	   ( SELECT SUM(CASE WHEN VBRK.FKART IN ('ZDV1','ZKR1',
    	     'ZDP1','ZNC1','ZNR1','ZAS1','ZAS2','ZB01','ZB03','ZDT1','S1') THEN (PRCD_ELEMENTS.KWERT * -1)
    	     ELSE PRCD_ELEMENTS.KWERT END)
    		 FROM SAPABAP1.PRCD_ELEMENTS 
             WHERE PRCD_ELEMENTS.KNUMV = VBRK.KNUMV
             AND PRCD_ELEMENTS.KPOSN = VBRP.POSNR
  			 AND PRCD_ELEMENTS.KSCHL IN ('ZFLT','ZFLM')
  							   ) AS FLETE,
    		
    		(ZCOSTO ) AS COSTO_INTERNO_TALLER,
		VBRP.VSTEL AS COD_PUESTO_EXPEDICION,
			VBRK.ZTERM AS COD_FPAGO,
			VBRP.AUBEL AS COD_PEDIDO
    		
   		FROM SAPABAP1.VBRK	  			 
   		
    
  INNER JOIN SAPABAP1.KNA1 ON VBRK.KUNAG = KNA1.KUNNR ---MAESTRO DE CLIENTES  ----- 
  INNER JOIN SAPABAP1.VBRP ON VBRK.VBELN = VBRP.VBELN --- DETALLE FACTURA POR MATERIAL ---
  INNER JOIN SAPABAP1.MARA ON VBRP.MATNR = MARA.MATNR --- MAESTRO DE MATERIALES ---
  --INNER JOIN SAPABAP1.ADRC ON ADRC.ADDRNUMBER = KNA1.ADRNR --- DIRECCIONES GEOGRAFICAS ---
 -- INNER JOIN SAPABAP1.T005U ON T005U.BLAND = ADRC.REGION --- PROVINCIA SECTORIZADAS ----
   					--AND T005U.LAND1 = ADRC.COUNTRY
  LEFT JOIN SAPABAP1.T023T ON MARA.MATKL = T023T.MATKL --- GRUPO DE MATERIALES ----
  LEFT JOIN SAPABAP1.T024X ON T024X.LABOR = MARA.LABOR ------- MARCAS --------
   					AND T024X.SPRAS = 'S'
   					AND T024X.MANDT = MARA.MANDT
  INNER JOIN SAPABAP1.TVTWT ON VBRP.VTWEG_AUFT = TVTWT.VTWEG ----- NOMBRE CANAL ----
  				   AND TVTWT.MANDT = '300'
				   AND TVTWT.SPRAS = 'S'
  INNER JOIN SAPABAP1.TSPAT ON VBRP.SPART = TSPAT.SPART  --- GRUPO ARTICULO ----
  				   AND TSPAT.MANDT = '300' 
				   AND TSPAT.SPRAS = 'S'
				   
  INNER JOIN SAPABAP1.MAKT ON MARA.MATNR = MAKT.MATNR   ---- NOMBRE MATERIALES ----
   				
  LEFT JOIN SAPABAP1.VBPA ON VBPA.VBELN = VBRK.VBELN --- CODIGOS DE AGENTE ---
						  AND VBPA.PARVW = 'Z3'
   LEFT JOIN SAPABAP1.VBPA VBPA2 ON VBPA2.VBELN = VBRK.VBELN --- CODIGOS DE AGENTE ---
						  AND VBPA2.PARVW = 'VD'
						  
  LEFT JOIN SAPABAP1.TVFKT ON VBRK.FKART = TVFKT.FKART
   						   AND TVFKT.MANDT = '300'
				           AND TVFKT.SPRAS = 'S'
  LEFT JOIN SAPABAP1.TVAUT ON TVAUT.AUGRU = VBRP.AUGRU_AUFT
  						   AND TVAUT.MANDT = '300'
				           AND TVAUT.SPRAS = 'S'
  LEFT JOIN SAPABAP1.TVKBT ON VBRP.VKBUR = TVKBT.VKBUR
                            AND TVKBT.MANDT = '300'
				           AND TVKBT.SPRAS = 'S'
  LEFT JOIN ( SELECT TB1.VBELN, SUM(KWERT) AS ZCOSTO
				FROM SAPABAP1.PRCD_ELEMENTS A

				INNER JOIN (
								SELECT VBRK.VBELN, VBAK.KNUMV, VBAP.POSNR
								FROM SAPABAP1.VBRP
								INNER JOIN SAPABAP1.VBRK ON VBRK.VBELN = VBRP.VBELN
								LEFT JOIN SAPABAP1.VBAK ON VBAK.vbeln = VBRP.aubel
								LEFT JOIN SAPABAP1.VBAP ON VBAP.vbeln = VBRP.aubel 
											   AND VBAP.uepos = VBRP.aupos 
											   AND VBAP.ABGRU =''
WHERE VBRK.FKART IN ('ZTA1','ZTA2')  ) TB1 ON  A.KNUMV = TB1.KNUMV AND
              							   	   A.KPOSN = TB1.POSNR AND
              							   	   A.KSCHL = 'VPRS'

GROUP BY TB1.VBELN ) TBZ_COSTO_INTERNO ON TBZ_COSTO_INTERNO.VBELN = VBRK.VBELN

 WHERE   MONTH(VBRK.FKDAT) = MONTH(ADD_DAYS(CURRENT_DATE, - 1)) AND YEAR(VBRK.FKDAT) = YEAR(ADD_DAYS(CURRENT_DATE, - 1))
 
--MONTH(VBRK.FKDAT) = 7 AND YEAR(VBRK.FKDAT) = 2020
   
   GROUP BY VBRK.KNUMV,
   			VBRP.POSNR,
   			VBRK.VBELN,
			VBRK.FKDAT,
			VBRK.VKORG,
			VBRK.VTWEG,
			KNA1.KUNNR,
			KNA1.NAME1,
			KNA1.MCOD3,
			--T005U.BEZEI,
			MARA.SPART,
			MARA.MATKL,
			T023T.WGBEZ,
			MARA.BISMT,
			VBRP.MATNR,
			VBRP.ARKTX,
			MARA.LABOR,
			T024X.LBTXT,
			TVTWT.VTEXT,
			TSPAT.VTEXT,
			VBPA.KUNNR,
			MAKT.MAKTX,
			VBRK.FKART,
			TVFKT.VTEXT,
			VBRK.ERNAM,
			VBRP.AUGRU_AUFT,
			TVAUT.BEZEI,
			VBRP.VKBUR,
			TVKBT.BEZEI,
			VBPA2.KUNNR,
			VBRP.VGBEL,
			VBRP.VBELN,
			VBRP.VRKME,
			VBRP.VSTEL,
			VBRK.ZTERM,
			VBRP.AUBEL,
			ZCOSTO