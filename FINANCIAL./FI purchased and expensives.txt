SELECT FECHA,
		COD_CTA_CONTABLE,
		COD_CENTRO_COSTO,
		COD_CONTABLE,
		SUM(VALOR) AS IMPORTE
FROM (
SELECT 	A.BUDAT AS FECHA,
		A.HKONT     COD_CTA_CONTABLE,
		A.KOSTL		COD_CENTRO_COSTO,
		A.BELNR AS COD_CONTABLE,
		A.SGTXT AS TEXTO,
		CASE A.SHKZG
			WHEN 'H' THEN SUM((A.DMBTR * -1 ))  - IFNULL(D.MONTO,0)
			ELSE SUM(A.DMBTR)  - IFNULL(D.MONTO,0)
		 END AS VALOR  
		
FROM  	 SAPABAP1.BSIS A

LEFT JOIN 
	 	 SAPABAP1.CSKS B ON B.KOSTL = A.KOSTL
LEFT JOIN 
			(SELECT DISTINCT
BSEG.BELNR AS DOC_CONTABLE,
BSEG.AUGBL AS DOC_COMPENSACION,
BSEG.LIFNR AS COD_ACREDOR
FROM SAPABAP1.BSEG
WHERE BSEG.BUKRS = '1000'
AND BSEG.MANDT = '300'
AND BSEG.AUGDT = '00000000'
AND BSEG.BELNR NOT LIKE '9%' ) C ON A.BELNR = C.DOC_CONTABLE

LEFT JOIN 
( SELECT SGTXT,BELNR,SUM(DMBTR) AS MONTO 
		 FROM SAPABAP1.BSAS 
		 GROUP BY SGTXT	, BELNR	) D ON A.SGTXT = D.SGTXT
		 							AND A.BELNR = D.BELNR
		 							

WHERE 		
   	A.MANDT = 300
  AND 	A.BUKRS = 1000                      
  AND 	A.AUGDT = '00000000'                
  AND   A.AUGBL = ''                        
  AND (A.HKONT LIKE '51%'
  OR A.HKONT LIKE '52%'
  OR A.HKONT LIKE '53%')
AND 	A.MONAT < 13
AND 	A.GJAHR > '2016'
AND C.COD_ACREDOR = '0000352425'
--AND A.BELNR = '2500104589'
GROUP BY A.GJAHR ,
		 A.MONAT ,
		 A.HKONT ,
		 A.KOSTL ,
		 A.SHKZG, 
		 A.BUDAT,
		 A.BELNR,
		 D.MONTO ,
		 A.SGTXT )
		 
		WHERE VALOR <> 0
		GROUP BY 
		FECHA,
		COD_CTA_CONTABLE,
		COD_CENTRO_COSTO,
		COD_CONTABLE